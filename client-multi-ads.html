<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel de Anuncios</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a0a1f 0%, #2d1f3d 50%, #1a0a1f 100%);
            color: white;
            overflow-x: hidden;
        }
        
        /* Fondo con burbujas animadas */
        .bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,20,147,0.3), rgba(153,50,204,0.3));
            animation: float 15s infinite ease-in-out;
        }
        
        .bubble:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
        .bubble:nth-child(2) { width: 60px; height: 60px; left: 30%; animation-delay: 2s; }
        .bubble:nth-child(3) { width: 100px; height: 100px; left: 50%; animation-delay: 4s; }
        .bubble:nth-child(4) { width: 40px; height: 40px; left: 70%; animation-delay: 6s; }
        .bubble:nth-child(5) { width: 70px; height: 70px; left: 85%; animation-delay: 8s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header con imagen de mujer */
        .header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(180deg, rgba(255,20,147,0.2) 0%, transparent 100%);
            border-radius: 0 0 50px 50px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF1493, #9932CC);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(255,20,147,0.5);
            position: relative;
            overflow: hidden;
        }
        
        .header-image svg {
            width: 80px;
            height: 80px;
        }
        
        .header-glow {
            position: absolute;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,20,147,0.4) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
        }
        
        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(90deg, #FF69B4, #FF1493, #DA70D6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            color: #DA70D6;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* Info del cliente */
        .client-info {
            background: linear-gradient(135deg, rgba(255,20,147,0.15), rgba(153,50,204,0.15));
            border: 1px solid rgba(255,20,147,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .client-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #FF69B4;
            margin-bottom: 5px;
        }
        
        .client-stats {
            color: #DA70D6;
            font-size: 0.85em;
        }
        
        /* Tarjetas de anuncios */
        .ad-card {
            background: linear-gradient(145deg, rgba(45,31,61,0.9), rgba(26,10,31,0.9));
            border: 1px solid rgba(255,20,147,0.2);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .ad-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(255,20,147,0.2);
            border-color: rgba(255,20,147,0.4);
        }
        
        .ad-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #FF1493, #9932CC, #FF1493);
        }
        
        .ad-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .ad-phone {
            font-size: 1.4em;
            font-weight: 700;
            color: #FF69B4;
        }
        
        .ad-city {
            color: #DA70D6;
            font-size: 0.9em;
            margin-top: 3px;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-active {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #003d20;
        }
        
        .status-paused {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: #4d3200;
        }
        
        .status-expired {
            background: linear-gradient(135deg, #666, #444);
            color: #ccc;
        }
        
        .status-editing {
            background: linear-gradient(135deg, #9932CC, #663399);
            color: white;
            animation: pulse-edit 1s infinite;
        }
        
        @keyframes pulse-edit {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Stats boxes */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(255,20,147,0.1);
            border: 1px solid rgba(255,20,147,0.2);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-label {
            color: #DA70D6;
            font-size: 0.75em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: white;
        }
        
        .stat-value.time {
            font-family: 'Courier New', monospace;
            background: linear-gradient(90deg, #FF69B4, #FF1493);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Progress bar */
        .progress-container {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF1493, #9932CC);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        /* Detalles adicionales */
        .ad-details {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #999;
            font-size: 0.85em;
        }
        
        .detail-value {
            color: #DA70D6;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        /* Botones */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-pause {
            background: linear-gradient(135deg, #ffa500, #ff6b00);
            color: white;
        }
        
        .btn-pause:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255,165,0,0.4);
        }
        
        .btn-resume {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #003d20;
        }
        
        .btn-resume:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,255,136,0.4);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #9932CC, #663399);
            color: white;
        }
        
        .btn-edit:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(153,50,204,0.4);
        }
        
        .btn-disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }
        
        .btn-full {
            grid-column: 1 / -1;
        }
        
        /* No ads message */
        .no-ads {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(145deg, rgba(45,31,61,0.5), rgba(26,10,31,0.5));
            border-radius: 25px;
            border: 1px dashed rgba(255,20,147,0.3);
        }
        
        .no-ads-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .no-ads h3 {
            color: #FF69B4;
            margin-bottom: 10px;
        }
        
        .no-ads p {
            color: #999;
        }
        
        /* Error message */
        .error-container {
            text-align: center;
            padding: 60px 20px;
        }
        
        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .error-container h2 {
            color: #FF69B4;
            margin-bottom: 10px;
        }
        
        /* Modal para editar */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: linear-gradient(145deg, #2d1f3d, #1a0a1f);
            border: 1px solid rgba(255,20,147,0.3);
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 450px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            color: #FF69B4;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: #FF69B4;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-group label {
            display: block;
            color: #DA70D6;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255,20,147,0.3);
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1em;
            font-family: inherit;
        }
        
        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23FF69B4' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }
        
        .form-group select option {
            background: #1a0a1f;
            color: white;
            padding: 10px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF1493;
            box-shadow: 0 0 10px rgba(255,20,147,0.3);
        }
        
        .modal-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #FF1493, #9932CC);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .modal-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255,20,147,0.4);
        }
        
        .modal-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Captcha section */
        .captcha-section {
            background: rgba(255,20,147,0.1);
            border: 2px dashed rgba(255,20,147,0.4);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .captcha-section h4 {
            color: #FF69B4;
            margin-bottom: 15px;
        }
        
        .captcha-image {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .captcha-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            letter-spacing: 5px;
            text-transform: uppercase;
        }
        
        .captcha-waiting {
            color: #DA70D6;
            padding: 30px;
        }
        
        .captcha-waiting .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,20,147,0.2);
            border-top-color: #FF1493;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Edit status messages */
        .edit-status {
            background: rgba(153,50,204,0.2);
            border: 1px solid rgba(153,50,204,0.4);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .edit-status.success {
            background: rgba(0,255,136,0.2);
            border-color: rgba(0,255,136,0.4);
        }
        
        .edit-status.error {
            background: rgba(255,0,0,0.2);
            border-color: rgba(255,0,0,0.4);
        }
        
        .edit-status h4 {
            margin-bottom: 10px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.8em;
        }
        
        .footer a {
            color: #FF69B4;
            text-decoration: none;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,20,147,0.2);
            border-top-color: #FF1493;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        /* Step indicator */
        .steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: #666;
        }
        
        .step.active {
            background: linear-gradient(135deg, #FF1493, #9932CC);
            color: white;
        }
        
        .step.done {
            background: #00cc6a;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Burbujas de fondo -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-image">
                <div class="header-glow"></div>
                <svg viewBox="0 0 100 100" fill="white">
                    <ellipse cx="50" cy="25" rx="18" ry="20"/>
                    <path d="M50 45 C25 45 15 70 15 95 L85 95 C85 70 75 45 50 45"/>
                    <ellipse cx="50" cy="22" rx="14" ry="16" fill="rgba(255,255,255,0.3)"/>
                </svg>
            </div>
            <h1>Mi Panel de Anuncios</h1>
            <p class="subtitle">Control total de tu publicidad</p>
        </div>
        
        <!-- Info del cliente -->
        <div class="client-info">
            <div class="client-name" id="clientName">Cargando...</div>
            <div class="client-stats" id="adsCount">-- anuncio(s)</div>
        </div>
        
        <!-- Contenedor de anuncios -->
        <div id="adsContainer">
            <div class="loading">
                <div class="spinner"></div>
                <p style="color: #DA70D6;">Cargando tus anuncios...</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            Powered by <a href="#">BotRedd</a> ü§ñ
        </div>
    </div>
    
    <!-- Modal para editar -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
            
            <!-- Paso 1: Formulario de edici√≥n -->
            <div id="editStep1">
                <h3>‚úèÔ∏è Editar Anuncio</h3>
                
                <div class="steps">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                </div>
                
                <input type="hidden" id="editAdId">
                
                <div class="form-group">
                    <label>üë§ Nombre / Alias</label>
                    <input type="text" id="editName" placeholder="Ej: Maria">
                </div>
                
                <div class="form-group">
                    <label>üí¨ T√≠tulo (Headline)</label>
                    <input type="text" id="editHeadline" placeholder="Ej: Llamame para disfrutar...">
                </div>
                
                <div class="form-group">
                    <label>üìù Descripci√≥n (Body)</label>
                    <textarea id="editBody" placeholder="Descripci√≥n de tu anuncio..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>üèôÔ∏è Estado</label>
                    <select id="editState" onchange="updateCities()">
                        <option value="">Selecciona un estado...</option>
                        <option value="Alabama">Alabama</option>
                        <option value="Alaska">Alaska</option>
                        <option value="Arizona">Arizona</option>
                        <option value="Arkansas">Arkansas</option>
                        <option value="California">California</option>
                        <option value="Colorado">Colorado</option>
                        <option value="Connecticut">Connecticut</option>
                        <option value="Delaware">Delaware</option>
                        <option value="Florida">Florida</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Hawaii">Hawaii</option>
                        <option value="Idaho">Idaho</option>
                        <option value="Illinois">Illinois</option>
                        <option value="Indiana">Indiana</option>
                        <option value="Iowa">Iowa</option>
                        <option value="Kansas">Kansas</option>
                        <option value="Kentucky">Kentucky</option>
                        <option value="Louisiana">Louisiana</option>
                        <option value="Maine">Maine</option>
                        <option value="Maryland">Maryland</option>
                        <option value="Massachusetts">Massachusetts</option>
                        <option value="Michigan">Michigan</option>
                        <option value="Minnesota">Minnesota</option>
                        <option value="Mississippi">Mississippi</option>
                        <option value="Missouri">Missouri</option>
                        <option value="Montana">Montana</option>
                        <option value="Nebraska">Nebraska</option>
                        <option value="Nevada">Nevada</option>
                        <option value="New Hampshire">New Hampshire</option>
                        <option value="New Jersey">New Jersey</option>
                        <option value="New Mexico">New Mexico</option>
                        <option value="New York">New York</option>
                        <option value="North Carolina">North Carolina</option>
                        <option value="North Dakota">North Dakota</option>
                        <option value="Ohio">Ohio</option>
                        <option value="Oklahoma">Oklahoma</option>
                        <option value="Oregon">Oregon</option>
                        <option value="Pennsylvania">Pennsylvania</option>
                        <option value="Rhode Island">Rhode Island</option>
                        <option value="South Carolina">South Carolina</option>
                        <option value="South Dakota">South Dakota</option>
                        <option value="Tennessee">Tennessee</option>
                        <option value="Texas">Texas</option>
                        <option value="Utah">Utah</option>
                        <option value="Vermont">Vermont</option>
                        <option value="Virginia">Virginia</option>
                        <option value="Washington">Washington</option>
                        <option value="West Virginia">West Virginia</option>
                        <option value="Wisconsin">Wisconsin</option>
                        <option value="Wyoming">Wyoming</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üìç Ciudad</label>
                    <select id="editCity">
                        <option value="">Primero selecciona un estado...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üè† Ubicaci√≥n/√Årea (Location)</label>
                    <input type="text" id="editLocation" placeholder="Ej: Downtown, Midtown, etc.">
                </div>
                
                <button class="modal-btn" onclick="submitEditRequest()">
                    üì§ Enviar Solicitud de Edici√≥n
                </button>
            </div>
            
            <!-- Paso 2: Esperando captcha -->
            <div id="editStep2" style="display: none;">
                <h3>üîê Verificaci√≥n de Seguridad</h3>
                
                <div class="steps">
                    <div class="step done">‚úì</div>
                    <div class="step active">2</div>
                    <div class="step">3</div>
                </div>
                
                <div id="captchaWaiting" class="captcha-waiting">
                    <div class="spinner"></div>
                    <p>Esperando c√≥digo de verificaci√≥n...</p>
                    <p style="font-size: 0.8em; color: #999; margin-top: 10px;">
                        El sistema est√° procesando tu solicitud.<br>
                        El c√≥digo aparecer√° en unos segundos.
                    </p>
                </div>
                
                <div id="captchaReady" class="captcha-section" style="display: none;">
                    <h4>Escribe el c√≥digo que ves en la imagen:</h4>
                    <img id="captchaImage" class="captcha-image" src="" alt="Captcha">
                    <input type="text" id="captchaInput" class="form-group captcha-input" placeholder="Escribe el c√≥digo aqu√≠">
                    <button class="modal-btn" onclick="submitCaptcha()">
                        ‚úÖ Confirmar C√≥digo
                    </button>
                    <button class="modal-btn" onclick="retryCaptcha()" style="background: #666; margin-top: 10px;">
                        üîÑ C√≥digo incorrecto? Reintentar
                    </button>
                </div>
            </div>
            
            <!-- Paso 3: Resultado -->
            <div id="editStep3" style="display: none;">
                <h3 id="resultTitle">‚è≥ Procesando...</h3>
                
                <div class="steps">
                    <div class="step done">‚úì</div>
                    <div class="step done">‚úì</div>
                    <div class="step active">3</div>
                </div>
                
                <div id="editResult" class="edit-status">
                    <div class="spinner"></div>
                    <p>Aplicando cambios a tu anuncio...</p>
                </div>
                
                <button class="modal-btn" id="closeResultBtn" onclick="closeEditModal()" style="display: none;">
                    üëç Entendido
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const FIREBASE_URL = 'https://ezequielredd-default-rtdb.firebaseio.com';
        const BUMP_INTERVAL = 15.42;
        
        let currentEditAdId = null;
        let captchaCheckInterval = null;
        let editStatusCheckInterval = null;
        
        // Ciudades por estado (MegaPersonals)
        const citiesByState = {
            "Alabama": ["Birmingham", "Huntsville", "Mobile", "Montgomery", "Tuscaloosa"],
            "Alaska": ["Anchorage", "Fairbanks", "Juneau"],
            "Arizona": ["Flagstaff", "Phoenix", "Prescott", "Sierra Vista", "Tucson", "Yuma"],
            "Arkansas": ["Fayetteville", "Fort Smith", "Jonesboro", "Little Rock", "Texarkana"],
            "California": ["Bakersfield", "Chico", "Fresno", "Humboldt", "Imperial County", "Inland Empire", "Long Beach", "Los Angeles", "Modesto", "Monterey Bay", "Orange County", "Palm Springs", "Sacramento", "San Diego", "San Francisco", "San Jose", "San Luis Obispo", "Santa Barbara", "Santa Maria", "Stockton", "Ventura", "Visalia"],
            "Colorado": ["Boulder", "Colorado Springs", "Denver", "Fort Collins", "Grand Junction", "Pueblo"],
            "Connecticut": ["Danbury", "Hartford", "New Haven", "Stamford", "Waterbury"],
            "Delaware": ["Dover", "Wilmington"],
            "Florida": ["Bradenton", "Daytona Beach", "Fort Lauderdale", "Fort Myers", "Gainesville", "Jacksonville", "Keys", "Lakeland", "Melbourne", "Miami", "Ocala", "Orlando", "Panama City", "Pensacola", "Sarasota", "Space Coast", "St Augustine", "Tallahassee", "Tampa", "Treasure Coast", "West Palm Beach"],
            "Georgia": ["Albany", "Athens", "Atlanta", "Augusta", "Columbus", "Macon", "Savannah", "Valdosta"],
            "Hawaii": ["Hawaii", "Honolulu", "Maui"],
            "Idaho": ["Boise", "Idaho Falls", "Lewiston", "Twin Falls"],
            "Illinois": ["Bloomington", "Carbondale", "Champaign", "Chicago", "Decatur", "Peoria", "Rockford", "Springfield", "St Louis"],
            "Indiana": ["Bloomington", "Evansville", "Fort Wayne", "Gary", "Indianapolis", "Kokomo", "Lafayette", "Muncie", "South Bend", "Terre Haute"],
            "Iowa": ["Ames", "Cedar Rapids", "Des Moines", "Dubuque", "Iowa City", "Quad Cities", "Sioux City", "Waterloo"],
            "Kansas": ["Kansas City", "Lawrence", "Manhattan", "Salina", "Topeka", "Wichita"],
            "Kentucky": ["Bowling Green", "Lexington", "Louisville", "Owensboro"],
            "Louisiana": ["Alexandria", "Baton Rouge", "Houma", "Lafayette", "Lake Charles", "Monroe", "New Orleans", "Shreveport"],
            "Maine": ["Bangor", "Portland"],
            "Maryland": ["Annapolis", "Baltimore", "Frederick", "Ocean City", "Salisbury"],
            "Massachusetts": ["Boston", "Cape Cod", "South Coast", "Springfield", "Worcester"],
            "Michigan": ["Ann Arbor", "Battle Creek", "Detroit", "Flint", "Grand Rapids", "Holland", "Jackson", "Kalamazoo", "Lansing", "Muskegon", "Port Huron", "Saginaw", "Upper Peninsula"],
            "Minnesota": ["Duluth", "Mankato", "Minneapolis", "Rochester", "St Cloud"],
            "Mississippi": ["Gulfport", "Hattiesburg", "Jackson", "Meridian", "North Mississippi", "Southwest Mississippi"],
            "Missouri": ["Columbia", "Jefferson City", "Joplin", "Kansas City", "Kirksville", "Lake of the Ozarks", "Southeast Missouri", "Springfield", "St Joseph", "St Louis"],
            "Montana": ["Billings", "Bozeman", "Butte", "Great Falls", "Helena", "Kalispell", "Missoula"],
            "Nebraska": ["Grand Island", "Lincoln", "Omaha", "Scottsbluff"],
            "Nevada": ["Elko", "Las Vegas", "Reno"],
            "New Hampshire": ["Concord", "Manchester", "Nashua", "Portsmouth"],
            "New Jersey": ["Atlantic City", "Central Jersey", "Jersey Shore", "North Jersey", "South Jersey"],
            "New Mexico": ["Albuquerque", "Clovis", "Farmington", "Las Cruces", "Roswell", "Santa Fe"],
            "New York": ["Albany", "Binghamton", "Buffalo", "Catskills", "Elmira", "Finger Lakes", "Glens Falls", "Hudson Valley", "Ithaca", "Long Island", "New York City", "Oneonta", "Plattsburgh", "Potsdam", "Rochester", "Syracuse", "Utica", "Watertown"],
            "North Carolina": ["Asheville", "Boone", "Charlotte", "Eastern NC", "Fayetteville", "Greensboro", "Hickory", "Jacksonville", "Outer Banks", "Raleigh", "Wilmington", "Winston-Salem"],
            "North Dakota": ["Bismarck", "Fargo", "Grand Forks", "Minot"],
            "Ohio": ["Akron", "Canton", "Chillicothe", "Cincinnati", "Cleveland", "Columbus", "Dayton", "Lima", "Mansfield", "Sandusky", "Toledo", "Youngstown", "Zanesville"],
            "Oklahoma": ["Lawton", "Oklahoma City", "Stillwater", "Tulsa"],
            "Oregon": ["Bend", "Corvallis", "Eugene", "Klamath Falls", "Medford", "Portland", "Roseburg", "Salem"],
            "Pennsylvania": ["Allentown", "Altoona", "Erie", "Harrisburg", "Lancaster", "Philadelphia", "Pittsburgh", "Poconos", "Reading", "Scranton", "State College", "Williamsport", "York"],
            "Rhode Island": ["Providence"],
            "South Carolina": ["Charleston", "Columbia", "Florence", "Greenville", "Hilton Head", "Myrtle Beach"],
            "South Dakota": ["Pierre", "Rapid City", "Sioux Falls"],
            "Tennessee": ["Chattanooga", "Clarksville", "Cookeville", "Johnson City", "Knoxville", "Memphis", "Nashville", "Tri-Cities"],
            "Texas": ["Abilene", "Amarillo", "Austin", "Beaumont", "Brownsville", "College Station", "Corpus Christi", "Dallas", "Del Rio", "El Paso", "Fort Worth", "Galveston", "Houston", "Killeen", "Laredo", "Lubbock", "McAllen", "Midland", "Odessa", "San Angelo", "San Antonio", "San Marcos", "Texarkana", "Tyler", "Victoria", "Waco", "Wichita Falls"],
            "Utah": ["Logan", "Ogden", "Provo", "Salt Lake City", "St George"],
            "Vermont": ["Burlington"],
            "Virginia": ["Charlottesville", "Danville", "Fredericksburg", "Hampton Roads", "Harrisonburg", "Lynchburg", "New River Valley", "Northern Virginia", "Richmond", "Roanoke", "Winchester"],
            "Washington": ["Bellingham", "Kennewick", "Moses Lake", "Olympia", "Seattle", "Spokane", "Tacoma", "Wenatchee", "Yakima"],
            "West Virginia": ["Charleston", "Eastern Panhandle", "Huntington", "Morgantown", "Parkersburg", "Southern WV", "Wheeling"],
            "Wisconsin": ["Appleton", "Eau Claire", "Green Bay", "Janesville", "Kenosha", "La Crosse", "Madison", "Milwaukee", "Racine", "Sheboygan", "Wausau"],
            "Wyoming": ["Casper", "Cheyenne", "Laramie"]
        };
        
        // Actualizar ciudades cuando se selecciona un estado
        function updateCities() {
            const stateSelect = document.getElementById('editState');
            const citySelect = document.getElementById('editCity');
            const selectedState = stateSelect.value;
            
            // Limpiar ciudades
            citySelect.innerHTML = '<option value="">Selecciona una ciudad...</option>';
            
            if (selectedState && citiesByState[selectedState]) {
                citiesByState[selectedState].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }
        
        // Obtener ID del cliente de la URL
        function getClientId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('client');
        }
        
        // Mostrar error
        function showError() {
            document.querySelector('.container').innerHTML = `
                <div class="error-container">
                    <div class="error-icon">üòï</div>
                    <h2>Link inv√°lido</h2>
                    <p style="color: #999;">Este enlace no es v√°lido o ha expirado.<br>Contacta al administrador.</p>
                </div>
            `;
        }
        
        // Obtener anuncios del cliente
        async function getClientAds() {
            const clientId = getClientId();
            if (!clientId) return null;
            
            try {
                const clientInfoRes = await fetch(`${FIREBASE_URL}/clientsInfo/${clientId}.json`);
                const clientInfo = await clientInfoRes.json();
                
                if (!clientInfo) return null;
                
                const adsRes = await fetch(`${FIREBASE_URL}/clients.json`);
                const allAds = await adsRes.json();
                
                if (!allAds) return { clientInfo, ads: [] };
                
                const clientAds = Object.entries(allAds)
                    .filter(([id, ad]) => ad.clientId === clientId)
                    .map(([id, ad]) => ({ id, ...ad }));
                
                return { clientInfo, ads: clientAds };
            } catch (error) {
                console.error('Error:', error);
                return null;
            }
        }
        
        // Pausar anuncio
        async function pauseAd(adId) {
            try {
                await fetch(`${FIREBASE_URL}/clients/${adId}/active.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(false)
                });
                cachedData = null;
                updateDashboard();
            } catch (error) {
                console.error('Error al pausar:', error);
            }
        }
        
        // Reanudar anuncio
        async function resumeAd(adId) {
            try {
                const now = Date.now();
                await fetch(`${FIREBASE_URL}/clients/${adId}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        active: true,
                        nextBumpTime: now + (BUMP_INTERVAL * 60 * 1000),
                        lastSync: now
                    })
                });
                cachedData = null;
                updateDashboard();
            } catch (error) {
                console.error('Error al reanudar:', error);
            }
        }
        
        // Abrir modal de edici√≥n
        async function openEditModal(adId) {
            currentEditAdId = adId;
            
            // Obtener datos actuales del anuncio
            try {
                const res = await fetch(`${FIREBASE_URL}/clients/${adId}.json`);
                const ad = await res.json();
                
                document.getElementById('editAdId').value = adId;
                document.getElementById('editName').value = ad.adName || '';
                document.getElementById('editHeadline').value = ad.adHeadline || '';
                document.getElementById('editBody').value = ad.adBody || '';
                document.getElementById('editLocation').value = ad.adLocation || '';
                
                // Cargar estado y ciudad
                if (ad.adState) {
                    document.getElementById('editState').value = ad.adState;
                    updateCities();
                    if (ad.city) {
                        document.getElementById('editCity').value = ad.city;
                    }
                }
                
                // Mostrar paso 1
                document.getElementById('editStep1').style.display = 'block';
                document.getElementById('editStep2').style.display = 'none';
                document.getElementById('editStep3').style.display = 'none';
                
                document.getElementById('editModal').classList.add('active');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar los datos del anuncio');
            }
        }
        
        // Cerrar modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            if (captchaCheckInterval) clearInterval(captchaCheckInterval);
            if (editStatusCheckInterval) clearInterval(editStatusCheckInterval);
            currentEditAdId = null;
            cachedData = null;
            updateDashboard();
        }
        
        // Enviar solicitud de edici√≥n
        async function submitEditRequest() {
            const adId = document.getElementById('editAdId').value;
            const state = document.getElementById('editState').value;
            const city = document.getElementById('editCity').value;
            
            // Obtener valores
            const adName = document.getElementById('editName').value.trim();
            const adHeadline = document.getElementById('editHeadline').value.trim();
            const adBody = document.getElementById('editBody').value.trim();
            const adLocation = document.getElementById('editLocation').value.trim();
            
            // Solo incluir campos que tienen valor (no vac√≠os)
            const editData = {};
            
            if (adName) editData.adName = adName;
            if (adHeadline) editData.adHeadline = adHeadline;
            if (adBody) editData.adBody = adBody;
            if (state) editData.adState = state;
            if (city) editData.city = city;
            if (adLocation) editData.adLocation = adLocation;
            
            // Verificar que al menos haya algo para editar
            if (Object.keys(editData).length === 0) {
                alert('Por favor llena al menos un campo para editar');
                return;
            }
            
            try {
                // Crear solicitud de edici√≥n en Firebase
                await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...editData,
                        status: 'pending',
                        requestedAt: Date.now(),
                        captchaImage: null,
                        captchaCode: null
                    })
                });
                
                // Pasar al paso 2
                document.getElementById('editStep1').style.display = 'none';
                document.getElementById('editStep2').style.display = 'block';
                document.getElementById('captchaWaiting').style.display = 'block';
                document.getElementById('captchaReady').style.display = 'none';
                
                // Empezar a verificar si lleg√≥ el captcha
                startCaptchaCheck(adId);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar la solicitud. Intenta de nuevo.');
            }
        }
        
        // Verificar si lleg√≥ el captcha
        function startCaptchaCheck(adId) {
            console.log('üîç Iniciando verificaci√≥n de captcha para:', adId);
            
            captchaCheckInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`);
                    const data = await res.json();
                    
                    console.log('üì¶ Datos de editRequest:', data);
                    
                    if (data && data.captchaImage) {
                        console.log('‚úÖ Captcha encontrado!');
                        clearInterval(captchaCheckInterval);
                        
                        // Mostrar captcha
                        document.getElementById('captchaWaiting').style.display = 'none';
                        document.getElementById('captchaReady').style.display = 'block';
                        document.getElementById('captchaImage').src = data.captchaImage;
                        document.getElementById('captchaInput').value = '';
                        document.getElementById('captchaInput').focus();
                    }
                    
                    // Si el status cambi√≥ a error
                    if (data && data.status === 'error') {
                        clearInterval(captchaCheckInterval);
                        showEditResult(false, data.errorMessage || 'Error al procesar la edici√≥n');
                    }
                    
                } catch (error) {
                    console.error('Error checking captcha:', error);
                }
            }, 2000);
        }
        
        // Enviar c√≥digo del captcha
        async function submitCaptcha() {
            const adId = document.getElementById('editAdId').value;
            const captchaCode = document.getElementById('captchaInput').value.trim();
            
            if (!captchaCode) {
                alert('Por favor escribe el c√≥digo');
                return;
            }
            
            try {
                // Enviar c√≥digo a Firebase
                await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        captchaCode: captchaCode,
                        status: 'captcha_received'
                    })
                });
                
                // Pasar al paso 3
                document.getElementById('editStep2').style.display = 'none';
                document.getElementById('editStep3').style.display = 'block';
                document.getElementById('resultTitle').textContent = '‚è≥ Procesando...';
                document.getElementById('editResult').innerHTML = `
                    <div class="spinner"></div>
                    <p>Aplicando cambios a tu anuncio...</p>
                    <p style="font-size: 0.8em; color: #999; margin-top: 10px;">
                        Esto puede tardar unos segundos.
                    </p>
                `;
                document.getElementById('editResult').className = 'edit-status';
                document.getElementById('closeResultBtn').style.display = 'none';
                
                // Verificar resultado
                startEditStatusCheck(adId);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al enviar el c√≥digo. Intenta de nuevo.');
            }
        }
        
        // Reintentar captcha (si el c√≥digo fue incorrecto)
        async function retryCaptcha() {
            const adId = document.getElementById('editAdId').value;
            
            if (!confirm('¬øEl c√≥digo fue incorrecto? Esto cancelar√° la edici√≥n actual y podr√°s intentar de nuevo.')) {
                return;
            }
            
            try {
                // Limpiar la solicitud de edici√≥n actual
                await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`, { method: 'DELETE' });
                
                // Quitar estado de editando
                await fetch(`${FIREBASE_URL}/clients/${adId}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ editStatus: null })
                });
                
                // Cerrar modal
                closeEditModal();
                
                // Mostrar mensaje
                alert('Edici√≥n cancelada. Puedes intentar de nuevo haciendo click en Editar.');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reintentar. Intenta de nuevo.');
            }
        }
        
        // Verificar estado de la edici√≥n
        function startEditStatusCheck(adId) {
            let checkCount = 0;
            const maxChecks = 10; // 10 * 2 segundos = 20 segundos m√°ximo
            
            editStatusCheckInterval = setInterval(async () => {
                try {
                    checkCount++;
                    
                    const res = await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`);
                    const data = await res.json();
                    
                    if (data && data.status === 'completed') {
                        clearInterval(editStatusCheckInterval);
                        showEditResult(true, '¬°Tu anuncio ha sido actualizado correctamente!');
                        
                        // Limpiar solicitud despu√©s de 5 segundos
                        setTimeout(async () => {
                            await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`, { method: 'DELETE' });
                        }, 5000);
                        return;
                    }
                    
                    if (data && data.status === 'error') {
                        clearInterval(editStatusCheckInterval);
                        showEditResult(false, data.errorMessage || 'Error al actualizar el anuncio');
                        return;
                    }
                    
                    // Si pas√≥ mucho tiempo (60 segundos), mostrar opci√≥n de reintentar
                    if (checkCount >= maxChecks) {
                        clearInterval(editStatusCheckInterval);
                        showEditResultWithRetry(adId);
                    }
                    
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 2000);
        }
        
        // Mostrar resultado con opci√≥n de reintentar
        function showEditResultWithRetry(adId) {
            const resultDiv = document.getElementById('editResult');
            const resultTitle = document.getElementById('resultTitle');
            
            resultTitle.textContent = '‚ö†Ô∏è Tiempo agotado';
            resultDiv.className = 'edit-status error';
            resultDiv.innerHTML = `
                <p>El proceso est√° tardando m√°s de lo esperado.</p>
                <p style="font-size: 0.9em; color: #ccc; margin-top: 10px;">
                    Posibles causas:<br>
                    ‚Ä¢ El c√≥digo del captcha fue incorrecto<br>
                    ‚Ä¢ Hubo un problema de conexi√≥n
                </p>
                <button class="modal-btn" onclick="retryFromResult('${adId}')" style="margin-top: 15px; background: #ff6b6b;">
                    üîÑ Reintentar Edici√≥n
                </button>
                <button class="modal-btn" onclick="closeEditModal()" style="margin-top: 10px; background: #666;">
                    ‚ùå Cerrar
                </button>
            `;
        }
        
        // Reintentar desde el resultado
        async function retryFromResult(adId) {
            try {
                // Limpiar la solicitud de edici√≥n actual
                await fetch(`${FIREBASE_URL}/editRequests/${adId}.json`, { method: 'DELETE' });
                
                // Quitar estado de editando
                await fetch(`${FIREBASE_URL}/clients/${adId}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ editStatus: null })
                });
                
                // Cerrar modal y refrescar
                closeEditModal();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al reintentar. Recarga la p√°gina.');
            }
        }
        
        // Mostrar resultado
        function showEditResult(success, message) {
            const resultDiv = document.getElementById('editResult');
            const resultTitle = document.getElementById('resultTitle');
            
            if (success) {
                resultTitle.textContent = '‚úÖ ¬°Completado!';
                resultDiv.className = 'edit-status success';
                resultDiv.innerHTML = `
                    <h4 style="color: #00ff88;">‚úÖ ¬°√âxito!</h4>
                    <p>${message}</p>
                `;
            } else {
                resultTitle.textContent = '‚ùå Error';
                resultDiv.className = 'edit-status error';
                resultDiv.innerHTML = `
                    <h4 style="color: #ff6b6b;">‚ùå Error</h4>
                    <p>${message}</p>
                `;
            }
            
            document.getElementById('closeResultBtn').style.display = 'block';
        }
        
        // Renderizar anuncio
        function renderAd(ad) {
            const now = Date.now();
            const endTime = ad.startTime + (ad.duration * 60 * 1000);
            const isExpired = now >= endTime;
            const isActive = ad.active && !isExpired;
            const isEditing = ad.editStatus === 'editing';
            
            // Estado
            let statusClass, statusText;
            if (isEditing) {
                statusClass = 'status-editing';
                statusText = 'Editando...';
            } else if (isExpired) {
                statusClass = 'status-expired';
                statusText = 'Finalizado';
            } else if (isActive) {
                statusClass = 'status-active';
                statusText = 'Activo';
            } else {
                statusClass = 'status-paused';
                statusText = 'Pausado';
            }
            
            // Pr√≥ximo bump
            const timeToNextBump = Math.max(0, ad.nextBumpTime - now);
            const bumpMinutes = Math.floor(timeToNextBump / 60000);
            const bumpSeconds = Math.floor((timeToNextBump % 60000) / 1000);
            const nextBumpStr = isExpired ? '--:--' : 
                `${String(bumpMinutes).padStart(2, '0')}:${String(bumpSeconds).padStart(2, '0')}`;
            
            // Tiempo restante
            const remaining = Math.max(0, endTime - now);
            const days = Math.floor(remaining / (24 * 60 * 60 * 1000));
            const hours = Math.floor((remaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            let remainingStr;
            if (isExpired) {
                remainingStr = 'Expirado';
            } else if (days > 0) {
                remainingStr = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else {
                remainingStr = `${hours}h ${minutes}m ${seconds}s`;
            }
            
            // Progreso
            const bumpTotal = BUMP_INTERVAL * 60 * 1000;
            const bumpProgress = isExpired ? 100 : Math.min(100, ((bumpTotal - timeToNextBump) / bumpTotal) * 100);
            const totalProgress = Math.min(100, ((now - ad.startTime) / (ad.duration * 60 * 1000)) * 100);
            
            // Fecha fin
            const endDateStr = new Date(endTime).toLocaleString('es-ES', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Bumps restantes
            const bumpsRemaining = isExpired ? 0 : Math.floor(remaining / (BUMP_INTERVAL * 60 * 1000));
            
            // Botones
            let actionBtn;
            if (isExpired) {
                actionBtn = `<button class="btn btn-disabled btn-full" disabled>Servicio Finalizado</button>`;
            } else if (isEditing) {
                actionBtn = `<button class="btn btn-disabled" disabled>‚è≥ Editando...</button>`;
            } else if (isActive) {
                actionBtn = `<button class="btn btn-pause" onclick="pauseAd('${ad.id}')">‚è∏Ô∏è Pausar</button>`;
            } else {
                actionBtn = `<button class="btn btn-resume" onclick="resumeAd('${ad.id}')">‚ñ∂Ô∏è Reanudar</button>`;
            }
            
            const editBtn = isExpired || isEditing ? '' : 
                `<button class="btn btn-edit" onclick="openEditModal('${ad.id}')">‚úèÔ∏è Editar</button>`;
            
            return `
                <div class="ad-card">
                    <div class="ad-header">
                        <div>
                            <div class="ad-phone">üìû ${ad.phone || 'Sin tel√©fono'}</div>
                            <div class="ad-city">üìç ${ad.city || 'Sin ciudad'}</div>
                        </div>
                        <div class="status-badge ${statusClass}">
                            <div class="status-dot"></div>
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">‚è∞ Pr√≥xima Publicaci√≥n</div>
                            <div class="stat-value time">${nextBumpStr}</div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${bumpProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">‚è≥ Tiempo Restante</div>
                            <div class="stat-value time" style="font-size: ${days > 0 ? '1.1em' : '1.5em'}">${remainingStr}</div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${totalProgress}%; background: linear-gradient(90deg, #00ff88, #00cc6a);"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ad-details">
                        <div class="detail-row">
                            <span class="detail-label">üìÖ Finaliza</span>
                            <span class="detail-value">${endDateStr}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">üîÑ Publicaciones restantes</span>
                            <span class="detail-value">${bumpsRemaining}</span>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        ${actionBtn}
                        ${editBtn}
                    </div>
                </div>
            `;
        }
        
        // Variables de cache
        let cachedData = null;
        let lastFetchTime = 0;
        const FETCH_INTERVAL = 5000;
        
        // Obtener datos con cache
        async function getDataWithCache() {
            const now = Date.now();
            if (!cachedData || (now - lastFetchTime) > FETCH_INTERVAL) {
                cachedData = await getClientAds();
                lastFetchTime = now;
            }
            return cachedData;
        }
        
        // Actualizar dashboard
        async function updateDashboard() {
            const data = await getDataWithCache();
            if (!data) return;
            
            document.getElementById('clientName').textContent = `üë§ ${data.clientInfo.name}`;
            
            const activeAds = data.ads.filter(ad => {
                const endTime = ad.startTime + (ad.duration * 60 * 1000);
                return Date.now() < endTime;
            }).length;
            document.getElementById('adsCount').textContent = `${data.ads.length} anuncio(s) ‚Ä¢ ${activeAds} activo(s)`;
            
            const container = document.getElementById('adsContainer');
            
            if (data.ads.length === 0) {
                container.innerHTML = `
                    <div class="no-ads">
                        <div class="no-ads-icon">üì≠</div>
                        <h3>No tienes anuncios</h3>
                        <p>Contacta al administrador para activar tus anuncios</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar: activos primero
            data.ads.sort((a, b) => {
                const now = Date.now();
                const aEnd = a.startTime + (a.duration * 60 * 1000);
                const bEnd = b.startTime + (b.duration * 60 * 1000);
                const aExpired = now >= aEnd;
                const bExpired = now >= bEnd;
                
                if (aExpired !== bExpired) return aExpired ? 1 : -1;
                if (a.active !== b.active) return a.active ? -1 : 1;
                return 0;
            });
            
            container.innerHTML = data.ads.map(ad => renderAd(ad)).join('');
        }
        
        // Inicializar
        const clientId = getClientId();
        if (!clientId) {
            showError();
        } else {
            updateDashboard();
            setInterval(updateDashboard, 1000);
            
            // Verificar si hay una edici√≥n en progreso con captcha
            checkPendingEdits();
            setInterval(checkPendingEdits, 3000);
        }
        
        // Verificar si hay ediciones pendientes con captcha
        async function checkPendingEdits() {
            try {
                // Obtener todos los anuncios del cliente
                const data = await getDataWithCache();
                if (!data || !data.ads) return;
                
                for (const ad of data.ads) {
                    // Verificar si hay una solicitud de edici√≥n para este anuncio
                    const res = await fetch(`${FIREBASE_URL}/editRequests/${ad.id}.json`);
                    const editRequest = await res.json();
                    
                    if (editRequest && editRequest.captchaImage && editRequest.status === 'waiting_captcha') {
                        console.log('üîî Captcha pendiente encontrado para:', ad.id);
                        
                        // Abrir el modal autom√°ticamente
                        if (!document.getElementById('editModal').classList.contains('active')) {
                            currentEditAdId = ad.id;
                            document.getElementById('editAdId').value = ad.id;
                            
                            // Mostrar paso 2 (captcha) directamente
                            document.getElementById('editStep1').style.display = 'none';
                            document.getElementById('editStep2').style.display = 'block';
                            document.getElementById('captchaWaiting').style.display = 'none';
                            document.getElementById('captchaReady').style.display = 'block';
                            document.getElementById('captchaImage').src = editRequest.captchaImage;
                            document.getElementById('captchaInput').value = '';
                            
                            document.getElementById('editModal').classList.add('active');
                            document.getElementById('captchaInput').focus();
                            
                            console.log('‚úÖ Modal de captcha abierto autom√°ticamente');
                        }
                        break;
                    }
                }
            } catch (error) {
                console.error('Error verificando ediciones pendientes:', error);
            }
        }
        
        // Cerrar modal al hacer click fuera
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>
